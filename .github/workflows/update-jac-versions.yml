name: Update Version Dropdowns in Issue Template

on:
  push:
    branches: [main]
    paths:
      - 'jac/pyproject.toml'
  schedule:
    - cron: '0 0 1 * *'  # Monthly â€” picks up new Python releases

permissions:
  contents: write

jobs:
  update-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Jac and Python version dropdowns
        run: |
          python3 - <<'EOF'
          import json, urllib.request, re

          template_path = '.github/ISSUE_TEMPLATE/1-bug-report.yml'

          with open(template_path, 'r') as f:
              content = f.read()

          def update_options(content, field_id, options):
              options_lines = '\n'.join(f'        - "{v}"' for v in options)
              return re.sub(
                  r'(    id: ' + field_id + r'\n(?:(?!    id:).)*?      options:\n)((?:        - ".*"\n)*)',
                  lambda m: m.group(1) + options_lines + '\n',
                  content,
                  flags=re.DOTALL
              )

          # --- Jac versions from PyPI ---
          with urllib.request.urlopen('https://pypi.org/pypi/jaclang/json') as r:
              jac_data = json.loads(r.read())

          def parse_ver(v):
              try: return [int(x) for x in v.split('.')]
              except: return [0]

          jac_versions = sorted(
              [v for v, files in jac_data['releases'].items() if files],
              key=parse_ver, reverse=True
          )[:5]

          content = update_options(content, 'jac-version', jac_versions + ['Older version'])
          print(f"Jac versions updated: {jac_versions}")

          # --- Python versions from endoflife.date ---
          with urllib.request.urlopen('https://endoflife.date/api/python.json') as r:
              py_data = json.loads(r.read())

          py_versions = [entry['cycle'] for entry in py_data if not entry.get('eol', False)][:5]

          content = update_options(content, 'python-version', py_versions + ['Older version'])
          print(f"Python versions updated: {py_versions}")

          with open(template_path, 'w') as f:
              f.write(content)
          EOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/ISSUE_TEMPLATE/1-bug-report.yml
          git diff --staged --quiet || (git commit -m "chore: update version dropdowns in issue template [skip ci]" && git push)
